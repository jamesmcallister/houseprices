resources:
- name: source-code
  type: git
  source:
    uri: git@github.com:jamesmcallister/houseprices.git
    branch: concourse
    private_key: {{private_key}}
  ignore_paths:
  - "docker"

- name: worker-source-code
  type: git
  source:
    uri: git@github.com:jamesmcallister/houseprices.git
    branch: concourse
    private_key: {{private_key}}
  paths:
  - "docker/worker"

- name: mc-source-code
  type: git
  source:
    uri: git@github.com:jamesmcallister/houseprices.git
    branch: concourse
    private_key: {{private_key}}
  paths:
  - "docker/mc"

- name: pipeline-worker
  type: docker-image
  source:
    repository: "concourse-registry:5000/pipeline-worker"
    insecure_registries: ["concourse-registry:5000"]


- name: mc
  type: docker-image
  source:
    repository: "concourse-registry:5000/mc"
    insecure_registries: ["concourse-registry:5000"]

jobs:
- name: nodejs-worker-build
  serial: true
  plan:
  - get: worker-source-code
    trigger: true
  - put: pipeline-worker
    params:
      build: worker-source-code/docker/worker

- name: mc-worker-build
  serial: true
  plan:
  - get: mc-source-code
    trigger: true
  - put: mc
    params:
      build: mc-source-code/docker/mc

- name: minio-setup
  plan:
  - get: mc
    passed:
    - mc-worker-build
    trigger: true
  - task: say-hello
    image: mc
    config:
      platform: linux
      run:
        path: mc
        args:
        - ls
        - minio

- name: npm test
  plan:
  - get: pipeline-worker
    passed:
     - nodejs-worker-build
  - get: source-code
    trigger: true
  - task: say-hello
    image: pipeline-worker
    config:
      platform: linux
      inputs:
        - name: source-code
      run:
        path: bash
        args:
        - -exc
        - |
          . ~/.bashrc
          pushd source-code
            npm install -DE
            ls ~/.nvm
            ls ~node_modules

          popd
